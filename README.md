# Abstract Workflow Language Schema

Application of [OO-LD](https://github.com/OO-LD/schema) on [Abstract Syntax Trees](https://en.wikipedia.org/wiki/Abstract_syntax_tree) in order share workflow descriptions and map them to RDF.

For illustration we use the AST generated by the python std-lib [ast module](https://docs.python.org/3/library/ast.html). However, the concept should work with any AST (examples see https://astexplorer.net/) although it is recommeded to stick to core language patterns with broad language support.

## Objectives
- Language-agnostic JSON serialization
- Support for any pattern that is supported by programming languages (Conditions, Loops, Function calls)
- Option to restrict supported features via JSON-SCHEMA (e.g. don't allow class declarations, allow only a whitelist of function calls, restrict function call parameters)
- Option to map to RDF via JSON-LD context in order to allow complex analytics and queries via SPARQL or SHACL (e.g. find all workflows that make use of certain functions in a specific order)

## Playground
A playground to work with AWL can be found here: [AWL Playground](https://oo-ld.github.io/playground-awl/?data=N4Ig9gDgLglmB2BnEAuUMDGCA2MBGqIAZglAIYDuApomALZUCsIANOHgFZUZQD62ZAJ5gArlELwwAJzplsrEIgwALKrNSgAAlnhQqAD3EoA2qEryUIZVCgREKAPQOwYALTYAJgDoA5jCjKInhecA7mrkqqsg4KBoTWtvZOBmR0ENhUXtI%2BMWyaeGSIVPE2do7Obp6%2B%2FoHBoeGRamS5ILxQghDFlprtnQowHoSaAwp4YB6ChOYoABKFAApkUuJsAHKpXVojltMAakswZHgZCtqkBkZaBUUlieUpaRlZUjkgAL5vbOQvVFDIOxRsLNCgAVJY%2BX4KABuchEmxAw0GAKBc0Q%2B2wcNOOj0hg0IBhGK6CIJmI%2BbAAkkQ8YipoCUJSsedcWgQGMJrSgZSQVJSZ9wFIqNgbsj6UQAGJyG5fGhGEDTVEAYQQHn8cHgCiwaSWZCg0n%2BcrpqIASjAfNY5vAPEqtVIddIFJB9fLCgB5Tq23VSBQZIiy52IAAyVF9Fqt9Ag2s9CiIIngGGp2wNKMKYtjPDVCrk8jy2Iu1OuRISZWS%2BlS6Uy2Ra6wYHJQqbjsAQ7z54KdhsKAEEXiIGLoFLwANZUQQUaQeNvJxAAaWHo6kHi7Ph7VD7bHBtdRM8mbwAul9%2FCdLB2AOoBhS9IlgTjccR8xDKMAUXhUKRSPWEGC6F9kdNNr5RIkxjAP4oFtCAABYFDIDgyH0VBQLhNghyoCBeAQKgwCIXgSRoVAiElKg%2BQ4Wh1RZNoOiJABZcYRBONg2UmExQHIvpLAZejxkY0xWgvQgO0QRBTXVL5wV%2Bf5uJYolq2KNhEwIXc2BwvFJMIJUkHIVd8VhLoAEYPj3flBWFCTeKPAShPPUS%2FlQEyKMIaT%2BiRVl3gMpSyNMkA1MQDSVi0wlUAAZn06VvOUjzrQjAUNXDSN3yYni7MsLyfOhbTUD0gyfUuBLWJABzZKcsh3jYR0bOYjyAFEAEcXOCkAL14ITpFwkwdw%2BIA%3D%3D) (Work in progress)

## Schema

### Python-AST
Note: The context makes use of type-scoped contexts, see https://www.w3.org/TR/json-ld11/#scoped-contexts

Note: The schema section is empty allowing any AST. However, workflow domains should define a restricted set of e.g. function calls that represent available and safe options.

```yaml
'@context':
  - awl: https://oo-ld.github.io/awl-schema/
    ex: https://example.org/
    '@base': https://oo-ld.github.io/awl-schema/
    _type: '@type'
    id: '@id'
    body: awl:HasPart
    Name:
      '@id': awl:Variable
      '@context':
        '@base': https://example.org/
    targets: awl:HasTarget
    value:
      '@id': awl:HasValue
      '@context':
        value: '@value'
    If:
      '@id': awl:If
      '@context':
        body: awl:IfTrue
    orelse: awl:IfFalse
    test: awl:HasCondition
    comparators: awl:HasRightHandComparator
    ops: awl:HasOperator
    left: awl:HasLeftHandComparator
    func:
      '@id': awl:HasFunctionCall
      '@context':
        '@base': https://example.org/
        Name: awl:Function
        value: awl:HasValue
    args: awl:HasArgument
    keywords:
      '@id': awl:HasKeywordArgument
      '@context':
        value: awl:HasValue
    arg: awl:HasKey
title: AWL
type: object
```

## Examples

### If-Else-Block

```python
if a == 1:
    b = 1
else:
    b = 'test'
```
> Python Code


```yaml
_type: Module
body:
  - _type: If
    body:
      - _type: Assign
        targets:
          - _type: Name
            id: b
        value:
          _type: Constant
          value: 1
    orelse:
      - _type: Assign
        targets:
          - _type: Name
            id: b
        value:
          _type: Constant
          value: test
    test:
      _type: Compare
      comparators:
        - _type: Constant
          value: 1
      left:
        _type: Name
        id: a
      ops:
        - _type: Eq
type_ignores: []
```
> AST


```turtle
<https://example.org/run> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Function> .
<https://example.org/x> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Variable> .
_:b0 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Module> .
_:b0 <https://oo-ld.github.io/awl-schema/HasPart> _:b1 .
_:b0 <https://oo-ld.github.io/awl-schema/HasPart> _:b3 .
_:b1 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Assign> .
_:b1 <https://oo-ld.github.io/awl-schema/HasTarget> <https://example.org/x> .
_:b1 <https://oo-ld.github.io/awl-schema/HasValue> _:b2 .
_:b2 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Call> .
_:b2 <https://oo-ld.github.io/awl-schema/HasFunctionCall> <https://example.org/run> .
_:b3 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Expr> .
_:b3 <https://oo-ld.github.io/awl-schema/HasValue> _:b4 .
_:b4 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Call> .
_:b4 <https://oo-ld.github.io/awl-schema/HasArgument> <https://example.org/x> .
_:b4 <https://oo-ld.github.io/awl-schema/HasFunctionCall> <https://example.org/run> .
```
> RDF


### Funtion call

```python
x = run(a=1))
run(x)
```
> Python Code


```yaml
_type: Module
body:
  - _type: Assign
    body: []
    value:
      _type: Call
      args: []
      func:
        _type: Name
        id: run
      keywords:
        - _type: keyword
          arg: a
          value:
            _type: Constant
            value: 1
    targets:
      - _type: Name
        id: x
  - _type: Expr
    body: []
    value:
      _type: Call
      args:
        - _type: Name
          id: x
      func:
        _type: Name
        id: run
      keywords: []
type_ignores: []
```
> AST


```turtle
<https://example.org/run> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Function> .
<https://example.org/x> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Variable> .
_:b0 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Module> .
_:b0 <https://oo-ld.github.io/awl-schema/HasPart> _:b1 .
_:b0 <https://oo-ld.github.io/awl-schema/HasPart> _:b3 .
_:b1 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Assign> .
_:b1 <https://oo-ld.github.io/awl-schema/HasTarget> <https://example.org/x> .
_:b1 <https://oo-ld.github.io/awl-schema/HasValue> _:b2 .
_:b2 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Call> .
_:b2 <https://oo-ld.github.io/awl-schema/HasFunctionCall> <https://example.org/run> .
_:b3 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Expr> .
_:b3 <https://oo-ld.github.io/awl-schema/HasValue> _:b4 .
_:b4 <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <https://oo-ld.github.io/awl-schema/Call> .
_:b4 <https://oo-ld.github.io/awl-schema/HasArgument> <https://example.org/x> .
_:b4 <https://oo-ld.github.io/awl-schema/HasFunctionCall> <https://example.org/run> .
```
> RDF

## Usecases

While it wouldn't make much sense to generate AWL for a complex python program it can be the right tool to define the high-leven function calling sequence on top of base libs. 
This is, for example, the case in the definition of battery cycling procedures consisting of a limited set of methodes and control structures:

```py
class VoltageUnit(str, Enum):
    """note: identifiers SHOULD be compatible with pint"""
    V: "<iri>"
    mV: "<iri>"

class Voltage(BaseModel):
    value: float
    unit: Optional[VoltageUnit] = VoltageUnit.V
    
class ChargeParam(BaseModel):
    target_voltage: Union[float, Voltage]

class Battery(BaseModel):
    def charge(self, param: ChargeParam):
        ...
```
> Common lib

```py
i = 0 
while (
        i < 1000 and
        battery.get(Temperature) < Temperature(100) and 
        battery.get(StateOfHealth) > StateOfHealth(80)    
):
    battery.charge(ChargingParam(target_voltage=Voltage(4.2), c_rate=CRate(0.23)))
    battery.discharge(ChargingParam(target_voltage=Voltage(3.7), c_rate=CRate(0.23)))
    battery.rest(RestParam(duration=Duration(10)))
    battery.set(StateOfHealth) = ...
    i += 1
```
> Specific procedure
